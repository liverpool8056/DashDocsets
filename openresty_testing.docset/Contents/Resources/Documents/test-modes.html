<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Test Modes</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_test_modes">Test Modes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One unique feature of <code>Test::Nginx</code> is that it allows running the same
test suite in wildly different ways, or test modes, by just configuring
some system environment variables. Different test modes have different
focuses and may find different categories of bugs or performance issues
in
the applications being tested. The data driven nature of the test framework
makes it easy to add new test modes without changing the user test files
at all. And it is also possible to combine different test modes to form
new (hybrid) test modes. The capability of running the same test suite
in many different ways helps squeezing more value out of the tests
we already have.</p>
</div>
<div class="paragraph">
<p>This section will iterate through various different test modes supported
by <code>Test::Nginx::Socket</code> and their corresponding system environment variables
used to enable or control them.</p>
</div>
<div class="sect2">
<h3 id="_benchmark_mode">Benchmark Mode</h3>
<div class="paragraph">
<p><code>Test::Nginx</code> has built-in support for performance testing or benchmarking.
It can invoke external load testing tools like <code>ab</code> and <code>weighttp</code> to load
each test case as hard as possible.</p>
</div>
<div class="paragraph">
<p>To enable this benchmark testing mode, you can specify the <code>TEST_NGINX_BENCHMARK</code>
system environment variable before running the <code>prove</code> command. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_BENCHMARK='2000 2'
prove t/foo.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will run all the test cases in <code>t/foo.t</code> in benchmark mode. In particular,
the first number, <code>2000</code> in the environment variable value indicates the
total number of requests used to flood the server while the second number,
<code>2</code>, means that the number of concurrent connections the client will use.</p>
</div>
<div class="paragraph">
<p>If the test case uses an HTTP 1.1 request (which is the default), then
the test scaffold
will invoke the <code>weighttp</code> tool. If it is an HTTP 1.0 request, then the
test scaffold invokes the <code>ab</code> tool.</p>
</div>
<div class="paragraph">
<p>This test mode requires the <code>unbuffer</code> command-line utility from the <code>expect</code>
package, as well as the <code>ab</code> and <code>weighttp</code> load testing tools. On Ubuntu/Debian
systems, we can install most of the dependencies with the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo apt-get install expect apache2-utils</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may need to build and install <code>weighttp</code> from source on Ubuntu/Debian
yourself due to the lack of the Debian package.</p>
</div>
<div class="paragraph">
<p>For the Mac OS X system, on the other hand, we can use <code>homebrew</code> to install
it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">brew install expect weighttp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s consider the following example.</p>
</div>
<div class="listingblock">
<div class="title">t/hello.t</div>
<div class="content">
<pre class="highlight"><code class="language-test-base" data-lang="test-base">use Test::Nginx::Socket 'no_plan';

run_tests();

__DATA__

=== TEST 1: hello world
--- config
    location = /hello {
        return 200 "hello world\n";
    }
--- request
    GET /hello
--- response_body
hello world</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we run this test file in the benchmark mode, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_BENCHMARK='200000 2'
prove t/hello.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/hello.t .. TEST 1: hello world
weighttp -c2 -k -n200000 http://127.0.0.1:1984/hello
weighttp - a lightweight and simple webserver benchmarking tool

starting benchmark...
spawning thread #1: 2 concurrent requests, 200000 total requests
progress:  10% done
progress:  20% done
progress:  30% done
progress:  40% done
progress:  50% done
progress:  60% done
progress:  70% done
progress:  80% done
progress:  90% done
progress: 100% done

finished in 2 sec, 652 millisec and 752 microsec, 75393 req/s, 12218 kbyte/s
requests: 200000 total, 200000 started, 200000 done, 200000 succeeded, 0 failed, 0 errored
status codes: 200000 2xx, 0 3xx, 0 4xx, 0 5xx
traffic: 33190005 bytes total, 30790005 bytes http, 2400000 bytes data
t/hello.t .. ok
All tests successful.
Files=1, Tests=2,  3 wallclock secs ( 0.01 usr  0.00 sys +  0.33 cusr  1.47 csys =  1.81 CPU)
Result: PASS</pre>
</div>
</div>
<div class="paragraph">
<p>The most important line in this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>finished in 2 sec, 652 millisec and 752 microsec, 75393 req/s, 12218 kbyte/s</pre>
</div>
</div>
<div class="paragraph">
<p>We can see that this test case can achieve 75393 requests per second and
12218 KB per second. Not bad for a single NGINX worker process!</p>
</div>
<div class="paragraph">
<p>It is also important to keep an eye on failed requests. We surely do not
care about the performance of error pages. We can get the number of error
responses by checking the following output lines:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>requests: 200000 total, 200000 started, 200000 done, 200000 succeeded, 0 failed, 0 errored
status codes: 200000 2xx, 0 3xx, 0 4xx, 0 5xx</pre>
</div>
</div>
<div class="paragraph">
<p>We are glad to see that all our requests succeeded in this run.</p>
</div>
<div class="paragraph">
<p>If we want to benchmark the performance of multiple NGINX worker processes
so as to utilize multiple CPU cores, then we can add the following lines
to the test file prologue, <em>before</em> the line <code>run_tests()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-perl" data-lang="perl">master_on();
workers(4);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way we can have 4 NGINX worker processes sharing the load.</p>
</div>
<div class="paragraph">
<p>Behind the scenes, the test scaffold assembles the command line involving
<code>weighttp</code> from the test block specification, in this case, the command
line looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">weighttp -c2 -k -n200000 http://127.0.0.1:1984/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>There exists complicated cases, however, where the test scaffold fails
to derive the exact command line equivalent.</p>
</div>
<div class="paragraph">
<p>We can also enforce HTTP 1.0 requests in our test block by appending the
"HTTP/1.0" string to the value of the <code>--- request</code> section:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>--- request
    GET /hello HTTP/1.0</pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the test scaffold will invoke the <code>ab</code> tool to flood the
matching HTTP 1.0 request. The output might look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/hello.t .. TEST 1: hello world
ab -r -d -S -c2 -k -n200000 http://127.0.0.1:1984/hello
This is ApacheBench, Version 2.3 &lt;$Revision: 1706008 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking 127.0.0.1 (be patient)
Completed 20000 requests
Completed 40000 requests
Completed 60000 requests
Completed 80000 requests
Completed 100000 requests
Completed 120000 requests
Completed 140000 requests
Completed 160000 requests
Completed 180000 requests
Completed 200000 requests
Finished 200000 requests


Server Software:        openresty/1.9.15.1
Server Hostname:        127.0.0.1
Server Port:            1984

Document Path:          /hello
Document Length:        12 bytes

Concurrency Level:      2
Time taken for tests:   3.001 seconds
Complete requests:      200000
Failed requests:        0
Keep-Alive requests:    198000
Total transferred:      33190000 bytes
HTML transferred:       2400000 bytes
Requests per second:    66633.75 [#/sec] (mean)
Time per request:       0.030 [ms] (mean)
Time per request:       0.015 [ms] (mean, across all concurrent requests)
Transfer rate:          10798.70 [Kbytes/sec] received

Connection Times (ms)
              min   avg   max
Connect:        0     0    1
Processing:     0     0  132
Waiting:        0     0  132
Total:          0     0  132
t/hello.t .. ok
All tests successful.
Files=1, Tests=2,  4 wallclock secs ( 0.02 usr  0.00 sys +  0.51 cusr  1.39 csys =  1.92 CPU)
Result: PASS</pre>
</div>
</div>
<div class="paragraph">
<p>The most important output lines, in this case, are</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Failed requests:        0
Requests per second:    66633.75 [#/sec] (mean)
Transfer rate:          10798.70 [Kbytes/sec] received</pre>
</div>
</div>
<div class="paragraph">
<p>Different hardware and operating systems may lead to very different results.
Therefore, it generally does not make sense at all to directly compare
numbers obtained from different machines and systems.</p>
</div>
<div class="paragraph">
<p>Clever users can write some external scripts to record and compare these
numbers across different runs, so as to keep track of performance changes
in the web server or application. Such comparison scripts must take into
account any measurement errors and any disturbances from other processes
running in the same system.</p>
</div>
<div class="paragraph">
<p>Performance benchmark is a large topic and we gives it a more detailed
treatment in a dedicated chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hup_reload_mode">HUP Reload Mode</h3>
<div class="paragraph">
<p>By default, the test scaffold always starts a fresh instance of the NGINX
server right before running each individual test block and stops the server
right after
the checks of the current test block are all done. This ensures that there
is no side effects among test blocks, especially those running successively.
But
it can also be desired to ensure everything also works fine when the NGINX
server is just reloading its configurations without a full server restart.
Such configuration
reloading is usually done via sending the <code>HUP</code> signal to the master process
of NGINX. So we usually call it "HUP reload".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
On some non-UNIX-style operating systems like Microsoft Windows,
there is no such things as signals. In such platforms, NGINX users usually
use the <code>-s reload</code>
command-line option of the <code>nginx</code> executable to do the same thing. It
should be noted, however, the use of
the <code>-s reload</code> option has one side effect that can be annoying: it loads
the nginx configuration <em>twice</em> instead of just once, which may incur unnecessary
initialization overhead. Therefore, we should always use the <code>HUP</code> signal
instead of <code>-s reload</code> whenever possible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One example of OpenResty features that behaves different upon HUP reload
than server
restart is the shared dictionary mechanism (<a href="https://github.com/openresty/lua-nginx-module/#lua_shared_dict">lua_shared_dict</a>)
that does not wipe out
any existing data in the shared memory storage during HUP reload. When
testing
this feature or application code relying on this feature, it is wise to
test how it behaves upon HUP reload. We saw in the past that some 3rd-party
NGINX C modules dealing with shared memory, for example, have bugs across
HUP reloads, like nasty memory leaks.</p>
</div>
<div class="paragraph">
<p><code>Test::Nginx</code> has built-in support for the HUP reload test mode, which
can be enabled by specifying the <code>TEST_NGINX_USE_HUP=1</code> environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_USE_HUP=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can run our existing test suite as usual but now HUP signal is
used by the test scaffold to reload the NGINX configuration specified by
different test blocks.
The NGINX server will only be automatically shut down when the test harness
finishes running each test file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We can even avoid the automatic server shutdown behavior upon test
file completion by specifying the <code>TEST_NGINX_NO_CLEAN=1</code> environment.
See the later section
<a href="#no-clean">Manual Debugging Mode</a> for more details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>UNIX signals like <code>HUP</code> usually work asynchronously. Thus, there is a delay
between the test scaffold finishes sending the <code>HUP</code> signal to the NGINX
server and the NGINX server forks off a new worker process using the newly
loaded configuration and starts accepting new connections with the new
worker. For this reason, there is a (small) chance that the request of
a test block is served by an NGINX worker process still using the configuration
specified by the previous test block. Although <code>Test::Nginx</code> tries hard
to wait as long as it can with some simple heuristics, some test blocks
may still experience some intermittent test failures due to the mismatch
of the NGINX configuration. Be prepared for such false positives when using
the HUP reload testing mode.  This is also one of the reasons why the HUP
reload mode is not the default. We hope this issue can be further improved
in the future.</p>
</div>
<div class="paragraph">
<p>Another limitation with the HUP reload mode is that HUP reloads only happen
upon test block boundaries. There are cases where it is desired to issue
HUP reload in the middle of a test block. We can achieve that by using
some custom Lua code in your test block to send a <code>HUP</code> signal yourself,
as in</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lua" data-lang="lua">local f = assert(io.open("t/servroot/logs/nginx.pid", "r"))
local master_pid = assert(f:read())
assert(f:close())
assert(os.execute("kill -HUP " .. master_pid) == 0)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_valgrind_mode">Valgrind Mode</h3>
<div class="paragraph">
<p>One of the biggest enemies in web servers or web applications that are
supposed
to run in a 24x7 manner is memory issues. Memory issues include memory
leaks, memory invalid reads (like reading beyond the buffer boundary),
and memory invalid writes (like buffer overflow). In case of memory leaks,
the processes can take up more and more memory in the system and eventually
exhaust all the physical memory available, leading to unresponsive systems
or triggering the system to start killing processes with force. Memory
invalid accesses, on the other hand, can lead to process crashes (like
segmentation faults), or worse, leading to nondeterminism in the process'
s behavior (like giving out wrong results).</p>
</div>
<div class="paragraph">
<p><a href="http://valgrind.org/">Valgrind</a> is a powerful tool for programmers to detect
a wide range of memory
issues, including many memory leaks and many memory invalid accesses. This
is usually for debugging lower level code like the OpenResty core (including
the NGINX core), the Lua or LuaJIT VM, as well as those Lua libraries involved
with C and/or FFI. Plain Lua code without using FFI is considered "safe"
and is not subject to most of the memory issues.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Plain Lua code without using FFI can still contain bugs that result
in memory leaks, like inserting new keys into a globally shared Lua table
without control or appending a string to a global Lua string infinitely.
Such memory leaks, however, cannot be detected by Valgrind since it is
managed by Lua or LuaJIT&#8217;s garbage collector.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Test::Nginx</code> provides a testing mode that can automatically use Valgrind
to run the existing tests and check if there is any memory issues that
can be caught by Valgrind. This test mode is called "Valgrind mode". To
enable this mode, just set the environment <code>TEST_NGINX_USE_VALGRIND</code>, as
in</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_USE_VALGRIND=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then just run the test files as usual.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-test-base" data-lang="test-base">=== TEST 1: C strlen()
--- config
    location = /t {
        content_by_lua_block {
            local ffi = require "ffi"
            local C = ffi.C

            if not pcall(function () return C.strlen end) then
                ffi.cdef[[
                    size_t strlen(const char *s);
                ]]
            end

            local buf = ffi.new("char[3]", {48, 49, 0})
            local len = tonumber(C.strlen(buf))
            ngx.say("strlen: ", len)
        }
    }
--- request
    GET /t
--- response_body
strlen: 2
--- no_error_log
[error]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use the <code>ffi.new</code> API to allocate a C string buffer of 3 bytes
long and initialize the buffer with the bytes 48, 49, and 0, in the decimal
ASCII code. Then we call the standard C function <code>strlen</code> via the <code>ffi.C</code>
API with our C string buffer.</p>
</div>
<div class="paragraph">
<p>It is worth noting that we need to first declare the <code>strlen</code> function
prototype via the <code>ffi.cdef</code> API. Since we declare the C function in the
request handler (<code>content_by_lua_block</code>), we should only declare it once
instead of upon every request. To achieve that, we use a Lua <code>if</code> statement
to check if the symbol <code>strlen</code> is already declared (when <code>strlen</code> is not
declared or defined, the Lua expression <code>C.strlen</code> would throw out a Lua
exception, which can make the <code>pcall</code> call fail).</p>
</div>
<div class="paragraph">
<p>This example contains no memory issues since we properly initialize our
C string buffer by setting the null terminator character (<code>\0</code>) at end
of our C string. The C function <code>strlen</code> should correctly report back the
length of the string, which is <code>2</code>, without reading beyond our buffer boundary.
Now we run this test file with the Valgrind mode enabled using the default
OpenResty installation&#8217;s <code>nginx</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_USE_VALGRIND=1
export PATH=/usr/local/openresty/nginx/sbin:$PATH

prove t/a.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>There should be a lot of output. The first few lines should look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/a.t .. TEST 1: C strlen()
==7366== Invalid read of size 4
==7366==    at 0x546AE31: str_fastcmp (lj_str.c:57)
==7366==    by 0x546AE31: lj_str_new (lj_str.c:166)
==7366==    by 0x547903C: lua_setfield (lj_api.c:903)
==7366==    by 0x4CAD18: ngx_http_lua_cache_store_code (ngx_http_lua_cache.c:119)
==7366==    by 0x4CAB25: ngx_http_lua_cache_loadbuffer (ngx_http_lua_cache.c:187)
==7366==    by 0x4CB61A: ngx_http_lua_content_handler_inline (ngx_http_lua_contentby.c:300)</pre>
</div>
</div>
<div class="paragraph">
<p>Ouch! Valgrind reports a memory invalid read error. Fortunately it is just
a false positive due to the optimization inside the LuaJIT VM when it is
trying to create a new Lua string. The LuaJIT code repository maintains
a file named <a href="https://github.com/LuaJIT/LuaJIT/blob/master/src/lj.supp">lj.supp</a>
that lists all the known Valgrind false positives
that can be used to suppress these messages. We can simply copy that file
over and rename it to <code>valgrind.suppress</code> in the current working directory.
Then <code>Test::Nginx</code> will automatically feed this <code>valgrind.suppress</code> file
into Valgrind while running the tests in Valgrind mode. Let&#8217;s try that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cp -i /path/to/luajit-2.0/src/lj.supp ./valgrind.suppress
prove t/a.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, the test scaffold is calmed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/a.t .. TEST 1: C strlen()
t/a.t .. ok
All tests successful.
Files=1, Tests=3,  2 wallclock secs ( 0.01 usr  0.00 sys +  1.51 cusr  0.06 csys =  1.58 CPU)
Result: PASS</pre>
</div>
</div>
<div class="paragraph">
<p>We might encounter other Valgrind false positives like some of those in
the NGINX core or the OpenSSL library. We can add those to the <code>valgrind.suppress</code>
file as needed. The <code>Test::Nginx</code> test scaffold always outputs suppression
rules that can be added directly to the suppression file. For the example
above, the last few lines of the output are like below.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
   &lt;insert_a_suppression_name_here&gt;
   Memcheck:Addr4
   fun:str_fastcmp
   fun:lj_str_new
   fun:lua_setfield
   fun:ngx_http_lua_cache_store_code
   fun:ngx_http_lua_cache_loadbuffer
   fun:ngx_http_lua_content_handler_inline
   fun:ngx_http_core_content_phase
   fun:ngx_http_core_run_phases
   fun:ngx_http_process_request
   fun:ngx_http_process_request_line
   fun:ngx_epoll_process_events
   fun:ngx_process_events_and_timers
   fun:ngx_single_process_cycle
   fun:main
}
t/a.t .. ok
All tests successful.
Files=1, Tests=3,  2 wallclock secs ( 0.01 usr  0.00 sys +  1.47 cusr  0.07 csys =  1.55 CPU)
Result: PASS</pre>
</div>
</div>
<div class="paragraph">
<p>The suppression rule generated is the stuff between the curly braces (including
the curly braces themselves):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
   &lt;insert_a_suppression_name_here&gt;
   Memcheck:Addr4
   fun:str_fastcmp
   fun:lj_str_new
   fun:lua_setfield
   fun:ngx_http_lua_cache_store_code
   fun:ngx_http_lua_cache_loadbuffer
   fun:ngx_http_lua_content_handler_inline
   fun:ngx_http_core_content_phase
   fun:ngx_http_core_run_phases
   fun:ngx_http_process_request
   fun:ngx_http_process_request_line
   fun:ngx_epoll_process_events
   fun:ngx_process_events_and_timers
   fun:ngx_single_process_cycle
   fun:main
}</pre>
</div>
</div>
<div class="paragraph">
<p>We could have simply copied and pasted this rule into the <code>valgrind.suppress</code>
file. It is worth mentioning however, we can make this rule more general
to exclude the C function frames belonging to the NGINX core and the ngx_lua
module (near the bottom of the rule) since this false positive is related
to LuaJIT only.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s continue our experiment with our current example. Now we edit our
test case and change the following line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lua" data-lang="lua">local buf = ffi.new("char[3]", {48, 49, 0})</code></pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lua" data-lang="lua">local buf = ffi.new("char[3]", {48, 49, 50})</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is, we replace the null character (with ASCII code 0) to a non-null
character whose ASCII code is 50. This change makes our C string buffer
lacks any null terminators and thus calling <code>strlen</code> on it will result
in memory reads beyond our buffer boundary.</p>
</div>
<div class="paragraph">
<p>Unfortunately running this edited test file fail to yield any Valgrind
error reports regarding this memory issue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/a.t .. TEST 1: C strlen()
t/a.t .. 1/?
#   Failed test 'TEST 1: C strlen() - response_body - response is expected (repeated req 0, req 0)'
#   at /home/agentzh/git/lua-nginx-module/../test-nginx/lib/Test/Nginx/Socket.pm line 1346.
#          got: "strlen: 4\x{0a}"
#       length: 10
#     expected: "strlen: 2\x{0a}"
#       length: 10
#     strings begin to differ at char 9 (line 1 column 9)
# Looks like you failed 1 test of 3.</pre>
</div>
</div>
<div class="paragraph">
<p>The response body check fails as expected. This time <code>strlen</code> returns 4,
which is larger than our buffer size, 3. This is a clear indication of
memory buffer over-read. So why does Valgrind fail to catch this?</p>
</div>
<div class="paragraph">
<p>To answer this question, we need some knowledge about how LuaJIT allocates
memory. By default, LuaJIT uses its own memory allocator atop the system
allocator (usually provided by the standard C library). For performance
reasons, LuaJIT pre-allocates large memory blocks than request. Because
Valgrind has no knowledge about LuaJIT&#8217;s own allocator and Lua user-level
buffer boundary definitions, it can be cheated and can get confused.</p>
</div>
<div class="paragraph">
<p>To remove this limitation, we can enforce LuaJIT to use the system allocator
instead of its own. To achieve this, we need build LuaJIT with special
compilation options like below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">make CCDEBUG=-g XCFLAGS='-DLUAJIT_USE_VALGRIND -DLUAJIT_USE_SYSMALLOC'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most important option is <code>-DLUAJIT_USE_SYSMALLOC</code> which forces LuaJIT
to use the system allocator. The other options are important for our debugging
as well, for example, the <code>CCDEBUG=-g</code> option is to enable debug symbols
in the LuaJIT binary while <code>-DLUAJIT_USE_VALGRIND</code> enables some other special
collaborations with Valgrind inside the LuaJIT VM.</p>
</div>
<div class="paragraph">
<p>If we are using the OpenResty bundle, we can simply build another special
version of OpenResty like below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./configure \
    --prefix=/opt/openresty-valgrind \
    --with-luajit-xcflags='-DLUAJIT_USE_VALGRIND -DLUAJIT_USE_SYSMALLOC' \
    --with-debug \
    -j4
make -j4
sudo make install</pre>
</div>
</div>
<div class="paragraph">
<p>This will build and install a special debug version of OpenResty for Valgrind
checks to the file system location <code>/opt/openresty-valgrind</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There is some other LuaJIT special build options that can further
help us, like <code>-DLUA_USE_APICHECK</code> and <code>-DLUA_USE_ASSERT</code>. But they are
beyond the scope of our current example.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s try running our previous buggy example with this special OpenResty
and Valgrind:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_USE_VALGRIND=1
export PATH=/opt/openresty-valgrind/nginx/sbin:$PATH

prove t/a.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time Valgrind succeeds in catching the memory bug!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/a.t .. TEST 1: C strlen()
==8128== Invalid read of size 1
==8128==    at 0x4C2BC34: strlen (in /usr/lib64/valgrind/vgpreload_memcheck-amd64-linux.so)
==8128==    by 0x5467217: lj_vm_ffi_call (in /opt/luajit21sysm/lib/libluajit-5.1.so.2.1.0)
==8128==    by 0x54B5DE7: lj_ccall_func (lj_ccall.c:1136)
==8128==    by 0x54CAD45: lj_cf_ffi_meta___call (lib_ffi.c:230)
==8128==    by 0x5465147: lj_BC_FUNCC (in /opt/luajit21sysm/lib/libluajit-5.1.so.2.1.0)
==8128==    by 0x4C72BC: ngx_http_lua_run_thread (ngx_http_lua_util.c:1015)
==8128==    by 0x4CB039: ngx_http_lua_content_by_chunk (ngx_http_lua_contentby.c:120)
...</pre>
</div>
</div>
<div class="paragraph">
<p>We omit the rest of the output for brevity. Here Valgrind reports an invalid
read of one byte of memory in the C function <code>strlen</code>, which is exactly
what we&#8217;d expect. Mission accomplished!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
LuaJIT built with the system allocator should only be used with Valgrind
only. On computer architectures like x86_64, such LuaJIT may not even start
up.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From this example, we can see how application-level memory allocation optimizations
and management can compromise the effectiveness of Valgrind&#8217;s memory issue
detection. Similarly, the NGINX core also comes with its own memory allocator
via "memory pools". Such memory pools tend to allocate page-sized memory
blocks for small allocations and thus can also inversely affect Valgrind'
s detection. OpenResty provides a <a href="https://github.com/openresty/no-pool-nginx">patch</a>
for the NGINX core to disable the memory pool optimizations altogether.
The easiest way to use the patch is to specify the <code>--with-no-pool-patch</code>
option when running the <code>./configure</code> script while building OpenResty.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Since NGINX 1.9.13, NGINX provides a C macro <code>NGX_DEBUG_PALLOC</code> which
when set can be used to achieve similar effect as OpenResty&#8217;s "no-pool
patch". But still the "no-pool patch" is much more aggressive and thorough
and can help find more potential memory problems in NGINX related C code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This Valgrind mode is used by OpenResty developers on a daily basis and
has helped locate countless memory manage bugs in the OpenResty C and Lua/FFI
code base. Interestingly, this test mode also located memory issues in
the official NGINX core and the official LuaJIT core. Unlike analyzing
core dumps, Valgrind can almost always find the first scene of memory offends,
studying the memory error reports can usually give rise to immediate code
fixes.</p>
</div>
<div class="paragraph">
<p>As with all the other tools, Valgrind has its own limitations and cannot
find all the memory issues even when we carefully disable application level
memory allocators as demonstrated above. For example,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>memory issues on
the C runtime stack cannot be caught by Valgrind (at least for Valgrind'
s default memcheck tool).</p>
</li>
<li>
<p>Also, memory leaks in application-level resource
managers cannot be detected. For example, memory leaks in NGINX&#8217;s global
memory pool won&#8217;t get detected since NGINX always destroy all the memory
pools upon process termination. Similarly, an ever growing Lua object managed
by the Lua garbage collector (GC) won&#8217;t get caught either, since the Lua
VM always frees all its GC-managed objects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Understanding the weakness of the tool is as important as understanding
its strengths. We shall see an alternative approach in the next section
for detecting leaks in the application-level memory managers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Google&#8217;s <a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">AddressSanitizer</a>
tool can also be used to detect memory
issues. As compared to Valgrind, it has the advantages of running much
faster
and can detect memory issues on the C runtime stack as well. Unfortunately
it has its own limitations too. For example, it requires special C/C++
compiler options to rebuild all the related C code and C libraries for
the best result. Also, it cannot find problems in dynamically generated
machine code (like from a Just-in-Time compiler) or hand-written
assembly code (like LuaJIT&#8217;s Lua interpreter). Therefore, OpenResty developers
use Valgrind much more often.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_naive_memory_leak_check_mode">Naive Memory Leak Check Mode</h3>
<div class="paragraph">
<p>As we have seen from the previous section, Valgrind is great at detecting
a wide range of memory leaks and memory invalid accesses. But Valgrind
also suffers from limitations in detecting leaks in application-level memory
managers such as garbage collectors (GC) and memory pools, which is also
quite common in reality. To see this, let&#8217;s consider the following simple
example that leaks in LuaJIT&#8217;s GC-managed memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-test-base" data-lang="test-base">=== TEST 1:
--- config
    location = /t {
        content_by_lua_block {
            package.path = "/path/to/some/lib/?.lua;" .. package.path
            ngx.say("ok")
        }
    }
--- request
    GET /t
--- response_body
ok
--- no_error_log
[error]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example demonstrates a common mistake made by many OpenResty beginners.
The <code>package.path</code> field specifies the search paths used by the <code>require</code>
builtin function for loading pure Lua modules. This string value is hooked
up in the global Lua table <code>package</code> which has the same lifetime as the
current Lua virtual machine (VM) instance. Since Lua VM instances usually
have the same lifetime as NGINX worker processes (unless the <code>lua_code_cache</code>
directive is turned off in <code>nginx.conf</code>), prepending a new string to the
value of <code>package.path</code> in a request handler like <code>content_by_lua_block</code>
apparently results in a memory leak.</p>
</div>
<div class="paragraph">
<p>Unfortunately Valgrind cannot find this leak at all since the leak happens
in the GC-managed memory inside the Lua VM because all such leaked memory
will always get released upon GC destruction (or VM destruction) before
the
current process exits, which fools Valgrind to think that there is no leaks
at all. Interested readers can try running this example with the "Valgrind
test mode" as explained in the previous section.</p>
</div>
<div class="paragraph">
<p>To address this limitation of Valgrind, <code>Test::Nginx::Socket</code> introduces
a new test mode called "naive memory leak check mode", or just "check leak
mode" for short. In this mode, the test scaffold performs the following
things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>loads the NGINX server with many of the test request specified in the
test block, in a way similar to the "benchmark test mode" we discussed
earlier,</p>
</li>
<li>
<p>and at the same time, periodically polls and records the memory footprint
of the NGINX worker process with the system command <code>ps</code>,</p>
</li>
<li>
<p>and finally analyzes the memory usage data points collected in 2) by
finds the slope (<code>k</code>) of a line that best fits those data points.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To make use of this mode, just specify the <code>TEST_NGINX_CHECK_LEAK=1</code> environment,
before running existing test files, as in</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export TEST_NGINX_CHECK_LEAK=1
prove t/a.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming the <code>t/a.t</code> test file contains the test block example given above,
we should get an output similar to the following.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/a.t .. TEST 1:
LeakTest: [3740 3756 3620 3624 4180 3808 4044 4240 4272 4888 3876 3520 4516
 4368 5216 4796 4420 4508 4068 5336 5220 3888 4196 4544 4100 3696 5028 5080
 4580 3936 5236 4308 5320 4748 5464 4032 5492 4996 4588 4932 4632 6388 5228
 5516 4680 5348 5420 5964 5436 5128 5720 6324 5700 4948 4312 6208 5192 5268
 5600 4144 6556 4248 5648 6612 4044 5408 5120 5120 5740 6048 6412 5636 6488
 5184 6036 5436 5808 4904 4980 6772 5148 7160 6576 6724 5024 6768 7264 5540
 5700 5284 5244 4512 5752 6752 6868 6064 4940 5636 6388 7468]
LeakTest: k=22.6
t/e.t .. ok
All tests successful.
Files=1, Tests=3,  6 wallclock secs ( 0.01 usr  0.01 sys +  0.61 cusr  1.68 csys =  2.31 CPU)
Result: PASS</pre>
</div>
</div>
<div class="paragraph">
<p>The special output lines from this test mode have the prefix <code>LeakTest:</code>.
The first such line lists all the data points for the memory footprint
size in the unit of kilo bytes (KB), collected every 0.02 seconds. And
the second line is the slope (<code>k</code>) of the data line that best fits these
data points. And in this case, <code>k</code> equals to <code>22.6</code>.</p>
</div>
<div class="paragraph">
<p>The slope of the line can usually serve as an indication for the speed
of memory leaking. The larger the slope is, the faster the leak is. A 2-digit
data line slope here is very likely an indication of memory
leak. To be sure, we plot these data points in a graph using the <code>gnuplot</code>
tool.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/check-leak-pkg-path.png" alt="check leak pkg path">
</div>
</div>
<div class="paragraph">
<p>There are quite some fluctuations in the graph. This is due to how  garbage
collector normally behaves. It usually allocates page-sized or even larger
memory blocks than actually requested for performance reasons and delays
the release of unused memory blocks because of the sweep phase or something
else. Still, it is clear that the memory usage is going up over all.</p>
</div>
<div class="paragraph">
<p>We can try enforcing a full garbage collection cycle upon the entry of
our request handler, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nginx" data-lang="nginx">content_by_lua_block {
    collectgarbage()
    package.path = "/path/to/some/lib/?.lua;" .. package.path
    ngx.say("ok")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way we can ensure that there is <em>no</em> memory garbage hanging around
after the point we call the Lua builtin function <code>collectgarbage()</code>.</p>
</div>
<div class="paragraph">
<p>Now the output looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>t/e.t .. TEST 1:
LeakTest: [2464 2464 2360 2464 2232 2520 2380 2536 2440 2320 2300 2464
 2576 2584 2540 2408 2608 2420 2596 2596 2332 2648 2660 2460 2680 2320
 2688 2616 2332 2628 2408 2728 2716 2380 2752 2360 2768 2376 2372 2376
 2732 2800 2808 2816 2464 2396 2668 2688 2848 2672 2412 2416 2536 2420
 2424 2632 2904 2668 2912 2564 2724 2448 2932 2944 2856 2960 2616 2672
 2976 2620 2984 2600 2808 2980 3004 2996 3236 3012 2724 3168 3072 3536
 3260 3412 3028 2700 2480 3188 2808 3536 2640 3056 2764 3052 3440 3308
 3064 2680 2828 3372]
LeakTest: k=7.4
t/e.t .. ok
All tests successful.
Files=1, Tests=3,  6 wallclock secs ( 0.02 usr  0.00 sys +  0.62 cusr  1.75 csys =  2.39 CPU)
Result: PASS</pre>
</div>
</div>
<div class="paragraph">
<p>We can see this time, the slope of the best-fitting line is much smaller,
but still much larger than 0.</p>
</div>
<div class="paragraph">
<p>The line graph is now much smoother, as expected:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/check-leak-pkg-path-gc.png" alt="check leak pkg path gc">
</div>
</div>
<div class="paragraph">
<p>And we can see that the line is still going upward relatively steadily
over time.</p>
</div>
<div class="paragraph">
<p>Large fluctuations and variations in the memory footprint may create noises
in our data samples and even result in false positives. We already saw
how big fluctuations may result in large data-fitting line slopes. It
is usually a
good idea to enforce full garbage collection cycles frequently to reduce
such noises at least in GC-managed memory. The <code>collectgarbage()</code> function,
however, is quite expensive in terms of CPU resources and may hurt the
over-all performance very badly. Ensure you do not call it often (like
in every request) in the "benchmark test mode" introduced above or even
in production applications.</p>
</div>
<div class="paragraph">
<p>In reality, this brute-force "check leak" test mode has helped catching
quite a lot of real memory leaks in OpenResty&#8217;s test suites over the years.
Most of those leaks made their way around the Valgrind test mode since
they happened in GC-managed memory or NGINX&#8217;s memory pools.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The NGINX no-pool patch mentioned in the previous section does not help
here since all the leaked memory blocks in the pool still get released
before the process exits.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nevertheless, there exists one big drawback of this test mode. Unlike Valgrind,
it cannot give any detailed information about the locations where leaks
(may) happen. All it reports are just data samples and other metrics that
verify just the <em>existence</em> of a leak (at least to some extend). We shall
see in a later chapter how we can use the "memory leak flame graphs" to
overcome this limitation even for leaks and big swings in GC-managed or
pool-managed memory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mockeagain_mode">Mockeagain Mode</h3>

</div>
<div class="sect2">
<h3 id="no-clean">Manual Debugging Mode</h3>

</div>
<div class="sect2">
<h3 id="_systemtap_mode">SystemTap Mode</h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-06-07 10:53:47 +0800
</div>
</div>
</body>
</html>